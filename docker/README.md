# Docker

## Содержание
1. [Введение в Docker](#введение-в-docker)
2. [Основные концепции](#основные-концепции)
3. [Архитектура Docker](#архитектура-docker)
4. [Работа с Docker](#работа-с-docker)
5. [Dockerfile](#dockerfile)
6. [Docker Compose](#docker-compose)
7. [Docker Swarm](#docker-swarm)
8. [Docker и Kubernetes](#docker-и-kubernetes)
9. [Безопасность](#безопасность)
10. [Лучшие практики](#лучшие-практики)
11. [Вопросы на собеседовании](#вопросы-на-собеседовании)

## Введение в Docker

Docker — это платформа с открытым исходным кодом, которая автоматизирует развертывание, масштабирование и управление приложениями в контейнерах. Docker позволяет упаковать приложение со всеми его зависимостями в стандартизированный модуль для разработки программного обеспечения.

### Ключевые особенности Docker:
- **Изоляция**: контейнеры изолируют приложения от инфраструктуры
- **Портативность**: контейнеры могут работать на любой платформе, поддерживающей Docker
- **Легковесность**: контейнеры используют и разделяют ядро хост-системы
- **Быстрота**: контейнеры запускаются за секунды
- **Масштабируемость**: легко масштабировать приложения и автоматизировать рабочие процессы
- **Эффективность**: более эффективное использование ресурсов по сравнению с виртуальными машинами

## Основные концепции

### Контейнер (Container)
Контейнер — это стандартная единица программного обеспечения, которая упаковывает код и все его зависимости, чтобы приложение работало быстро и надежно в разных вычислительных средах.

```bash
# Запуск контейнера
docker run -d --name my-container nginx:latest
```

### Образ (Image)
Образ — это легковесный, автономный, исполняемый пакет программного обеспечения, который включает все необходимое для запуска приложения: код, среду выполнения, библиотеки, переменные окружения и файлы конфигурации.

```bash
# Получение образа из Docker Hub
docker pull nginx:latest
```

### Реестр (Registry)
Реестр — это хранилище образов Docker. Docker Hub — это публичный реестр, который может использовать любой пользователь.

```bash
# Отправка образа в Docker Hub
docker push username/my-image:tag
```

### Том (Volume)
Том — это механизм для сохранения данных, генерируемых и используемых контейнерами Docker.

```bash
# Создание тома
docker volume create my-volume

# Запуск контейнера с томом
docker run -d --name my-container -v my-volume:/app/data nginx:latest
```

### Сеть (Network)
Сеть Docker позволяет контейнерам взаимодействовать друг с другом и с внешним миром.

```bash
# Создание сети
docker network create my-network

# Запуск контейнера в сети
docker run -d --name my-container --network my-network nginx:latest
```

## Архитектура Docker

Docker использует клиент-серверную архитектуру. Docker-клиент взаимодействует с Docker-демоном, который выполняет работу по созданию, запуску и распределению контейнеров Docker.

### Компоненты Docker:

#### Docker-демон (dockerd)
Docker-демон прослушивает API-запросы Docker и управляет объектами Docker, такими как образы, контейнеры, сети и тома.

#### Docker-клиент (docker)
Docker-клиент — это основной способ взаимодействия пользователей с Docker. Когда вы используете команды, такие как `docker run`, клиент отправляет эти команды демону Docker.

#### Docker-реестры
Docker-реестры хранят образы Docker. Docker Hub — это публичный реестр, который может использовать любой пользователь.

#### Docker-объекты
Docker-объекты включают образы, контейнеры, сети, тома, плагины и другие объекты.

```
+-------------+     +---------------+     +-----------------+
| Docker CLI  |---->| Docker Daemon |---->| Container      |
| (Client)    |     | (Server)      |     |                |
+-------------+     +---------------+     +-----------------+
                           |
                           v
                    +--------------+
                    | Docker Image |
                    | Registry     |
                    +--------------+
```

## Работа с Docker

### Основные команды Docker

#### Управление контейнерами
```bash
# Запуск контейнера
docker run -d --name my-container nginx:latest

# Список запущенных контейнеров
docker ps

# Список всех контейнеров
docker ps -a

# Остановка контейнера
docker stop my-container

# Запуск остановленного контейнера
docker start my-container

# Перезапуск контейнера
docker restart my-container

# Удаление контейнера
docker rm my-container

# Удаление всех остановленных контейнеров
docker container prune
```

#### Управление образами
```bash
# Список образов
docker images

# Получение образа
docker pull nginx:latest

# Создание образа из Dockerfile
docker build -t my-image:tag .

# Удаление образа
docker rmi my-image:tag

# Удаление всех неиспользуемых образов
docker image prune
```

#### Управление томами
```bash
# Создание тома
docker volume create my-volume

# Список томов
docker volume ls

# Удаление тома
docker volume rm my-volume

# Удаление всех неиспользуемых томов
docker volume prune
```

#### Управление сетями
```bash
# Создание сети
docker network create my-network

# Список сетей
docker network ls

# Подключение контейнера к сети
docker network connect my-network my-container

# Отключение контейнера от сети
docker network disconnect my-network my-container

# Удаление сети
docker network rm my-network

# Удаление всех неиспользуемых сетей
docker network prune
```

### Взаимодействие с контейнерами
```bash
# Выполнение команды в запущенном контейнере
docker exec -it my-container bash

# Просмотр логов контейнера
docker logs my-container

# Копирование файлов из контейнера
docker cp my-container:/path/to/file /local/path

# Копирование файлов в контейнер
docker cp /local/path/file my-container:/path/to/destination
```

## Dockerfile

Dockerfile — это текстовый файл, содержащий инструкции для создания образа Docker.

### Основные инструкции Dockerfile

```dockerfile
# Пример Dockerfile
FROM nginx:latest

# Метаданные
LABEL maintainer="example@example.com"
LABEL version="1.0"

# Рабочая директория
WORKDIR /app

# Копирование файлов
COPY . /app
COPY package.json /app/

# Установка зависимостей
RUN apt-get update && apt-get install -y \
    package1 \
    package2 \
    && rm -rf /var/lib/apt/lists/*

# Установка переменных окружения
ENV NODE_ENV=production
ENV PORT=3000

# Открытие портов
EXPOSE 80
EXPOSE 443

# Том
VOLUME ["/data"]

# Команда, выполняемая при запуске контейнера
CMD ["nginx", "-g", "daemon off;"]

# Точка входа
ENTRYPOINT ["nginx"]
```

### Многоэтапные сборки

Многоэтапные сборки позволяют создавать более эффективные образы Docker, используя несколько этапов сборки.

```dockerfile
# Этап сборки
FROM node:14 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# Этап production
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## Docker Compose

Docker Compose — это инструмент для определения и запуска многоконтейнерных приложений Docker. С помощью Compose вы используете YAML-файл для настройки служб вашего приложения.

### Пример docker-compose.yml

```yaml
version: '3'

services:
  web:
    build: ./web
    ports:
      - "80:80"
    volumes:
      - ./web:/var/www/html
    depends_on:
      - db
    environment:
      - DATABASE_HOST=db
      - DATABASE_USER=root
      - DATABASE_PASSWORD=example

  db:
    image: mysql:5.7
    volumes:
      - db_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=example
      - MYSQL_DATABASE=myapp

volumes:
  db_data:
```

### Основные команды Docker Compose

```bash
# Запуск служб
docker-compose up -d

# Остановка служб
docker-compose down

# Просмотр логов
docker-compose logs

# Выполнение команды в службе
docker-compose exec web bash

# Просмотр статуса служб
docker-compose ps

# Перезапуск служб
docker-compose restart
```

## Docker Swarm

Docker Swarm — это инструмент оркестрации контейнеров, который позволяет управлять кластером Docker-узлов как единой виртуальной системой.

### Основные концепции Docker Swarm

#### Узел (Node)
Узел — это экземпляр Docker, который участвует в Swarm. Узлы бывают двух типов: управляющие (manager) и рабочие (worker).

#### Сервис (Service)
Сервис — это определение задачи, которую выполняют узлы. Сервис определяет образ контейнера, количество реплик и другие параметры.

#### Задача (Task)
Задача — это единица работы, назначенная узлу. Каждая задача связана с одним контейнером.

### Основные команды Docker Swarm

```bash
# Инициализация Swarm
docker swarm init

# Присоединение узла к Swarm
docker swarm join --token <token> <manager-ip>:<port>

# Создание сервиса
docker service create --name my-service --replicas 3 nginx:latest

# Список сервисов
docker service ls

# Масштабирование сервиса
docker service scale my-service=5

# Обновление сервиса
docker service update --image nginx:1.19 my-service

# Удаление сервиса
docker service rm my-service
```

## Docker и Kubernetes

Docker и Kubernetes часто используются вместе, где Docker предоставляет контейнеризацию, а Kubernetes обеспечивает оркестрацию контейнеров.

### Интеграция Docker с Kubernetes

- Docker используется для создания контейнеров, которые затем развертываются в кластере Kubernetes
- Kubernetes использует образы Docker для создания подов
- Kubernetes может использовать Docker как среду выполнения контейнеров (Container Runtime)

### Различия между Docker Swarm и Kubernetes

| Функция | Docker Swarm | Kubernetes |
|---------|--------------|------------|
| Сложность | Проще в настройке и использовании | Более сложный, но более мощный |
| Масштабируемость | Хорошо работает для небольших кластеров | Лучше масштабируется для больших кластеров |
| Автомасштабирование | Ограниченное | Встроенное автомасштабирование |
| Обновления | Поддерживает обновления без простоев | Более гибкие стратегии обновления |
| Сеть | Встроенная оверлейная сеть | Требует сторонних плагинов |
| Хранение | Ограниченные возможности | Более гибкие возможности |

## Безопасность

### Лучшие практики безопасности Docker

#### Образы
- Используйте официальные образы
- Сканируйте образы на уязвимости
- Используйте минимальные базовые образы (Alpine, distroless)
- Не запускайте контейнеры от имени root

```dockerfile
# Пример создания непривилегированного пользователя
FROM alpine:latest
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser
```

#### Контейнеры
- Ограничивайте ресурсы контейнеров
- Используйте сети для изоляции контейнеров
- Не монтируйте чувствительные директории хоста
- Используйте секреты для хранения чувствительных данных

```bash
# Ограничение ресурсов контейнера
docker run -d --name my-container --memory="512m" --cpus="1.0" nginx:latest
```

#### Хост
- Регулярно обновляйте Docker
- Ограничивайте доступ к Docker API
- Используйте аудит для отслеживания действий
- Настройте AppArmor или SELinux

## Лучшие практики

### Оптимизация образов
- Используйте многоэтапные сборки
- Минимизируйте количество слоев
- Объединяйте команды RUN
- Используйте .dockerignore
- Удаляйте ненужные файлы в том же слое

```dockerfile
# Плохо
FROM ubuntu:20.04
RUN apt-get update
RUN apt-get install -y package1
RUN apt-get install -y package2
RUN rm -rf /var/lib/apt/lists/*

# Хорошо
FROM ubuntu:20.04
RUN apt-get update && apt-get install -y \
    package1 \
    package2 \
    && rm -rf /var/lib/apt/lists/*
```

### Управление контейнерами
- Используйте именованные тома вместо привязок
- Не храните данные в контейнерах
- Используйте health checks
- Правильно обрабатывайте сигналы завершения

```dockerfile
# Пример health check
FROM nginx:latest
HEALTHCHECK --interval=5s --timeout=3s \
  CMD curl -f http://localhost/ || exit 1
```

### CI/CD с Docker
- Автоматизируйте сборку образов
- Тестируйте образы перед развертыванием
- Используйте теги для версионирования образов
- Реализуйте непрерывную доставку

## Вопросы на собеседовании

### Основные концепции Docker

#### Что такое Docker и в чем его преимущества?
Docker — это платформа для разработки, доставки и запуска приложений в контейнерах. Преимущества Docker:
- Изоляция приложений
- Портативность (работает везде)
- Легковесность (по сравнению с виртуальными машинами)
- Быстрый запуск
- Эффективное использование ресурсов
- Упрощение процесса разработки и развертывания

#### В чем разница между контейнером и виртуальной машиной?
- **Контейнеры**:
  - Используют ядро хост-системы
  - Легковесные (МБ)
  - Запускаются за секунды
  - Меньшая изоляция
  - Более эффективное использование ресурсов
- **Виртуальные машины**:
  - Имеют собственное ядро
  - Тяжеловесные (ГБ)
  - Запускаются за минуты
  - Полная изоляция
  - Менее эффективное использование ресурсов

#### Что такое образ Docker и как он связан с контейнером?
Образ Docker — это шаблон только для чтения, который содержит набор инструкций для создания контейнера Docker. Контейнер — это запущенный экземпляр образа. Образ можно сравнить с классом в объектно-ориентированном программировании, а контейнер — с экземпляром класса.

### Работа с Docker

#### Какие основные команды Docker вы знаете?
- `docker run`: запуск контейнера
- `docker ps`: список запущенных контейнеров
- `docker build`: создание образа из Dockerfile
- `docker pull`: получение образа из реестра
- `docker push`: отправка образа в реестр
- `docker exec`: выполнение команды в запущенном контейнере
- `docker logs`: просмотр логов контейнера
- `docker stop/start/restart`: управление жизненным циклом контейнера
- `docker rm/rmi`: удаление контейнеров/образов

#### Что такое Dockerfile и какие основные инструкции он содержит?
Dockerfile — это текстовый файл, содержащий инструкции для создания образа Docker. Основные инструкции:
- `FROM`: базовый образ
- `RUN`: выполнение команды
- `COPY/ADD`: копирование файлов
- `WORKDIR`: установка рабочей директории
- `ENV`: установка переменных окружения
- `EXPOSE`: объявление портов
- `VOLUME`: создание точки монтирования
- `CMD`: команда по умолчанию
- `ENTRYPOINT`: точка входа

#### Что такое Docker Compose и для чего он используется?
Docker Compose — это инструмент для определения и запуска многоконтейнерных приложений Docker. Он позволяет:
- Определять несколько служб в одном файле
- Запускать все службы одной командой
- Управлять жизненным циклом всего приложения
- Определять сети и тома
- Устанавливать зависимости между службами

### Продвинутые темы

#### Как работает многоэтапная сборка в Docker?
Многоэтапная сборка позволяет использовать несколько образов в одном Dockerfile для создания оптимизированного финального образа. Процесс:
1. Определение нескольких этапов с разными базовыми образами
2. Использование первого этапа для сборки/компиляции
3. Копирование только необходимых артефактов в финальный этап
4. Создание минимального образа для production

#### Как обеспечить безопасность контейнеров Docker?
Для обеспечения безопасности контейнеров Docker следует:
- Использовать официальные или проверенные образы
- Сканировать образы на уязвимости
- Не запускать контейнеры от имени root
- Ограничивать ресурсы контейнеров
- Использовать сети для изоляции контейнеров
- Не монтировать чувствительные директории хоста
- Регулярно обновлять Docker и образы
- Использовать секреты для хранения чувствительных данных

#### Как организовать хранение данных в Docker?
Для хранения данных в Docker можно использовать:
- **Тома (Volumes)**: управляемые Docker, хранятся в части файловой системы хоста
- **Привязки (Bind mounts)**: файл или директория на хосте монтируется в контейнер
- **tmpfs**: хранение данных в памяти
- **Драйверы хранения**: позволяют использовать внешние системы хранения

Лучшие практики:
- Использовать именованные тома для постоянных данных
- Не хранить данные внутри контейнеров
- Использовать соответствующие драйверы для конкретных сценариев
- Регулярно создавать резервные копии данных